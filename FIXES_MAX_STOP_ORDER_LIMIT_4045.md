# –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏ -4045 "Reach max stop order limit"

## üî¥ –ö–†–ò–¢–ò–ß–ù–ê –ü–†–û–ë–õ–ï–ú–ê: –ü–æ–º–∏–ª–∫–∞ -4045 –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ TP/SL –æ—Ä–¥–µ—Ä—ñ–≤

### –ü—Ä–æ–±–ª–µ–º–∞
–ë–æ—Ç –æ—Ç—Ä–∏–º—É—î –ø–æ–º–∏–ª–∫—É **-4045 "Reach max stop order limit"** –ø—Ä–∏ —Å–ø—Ä–æ–±—ñ –æ–Ω–æ–≤–∏—Ç–∏ TP/SL –æ—Ä–¥–µ—Ä–∏. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –Ω–∞ –±—ñ—Ä–∂—ñ –¥–æ—Å—è–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∏—Ö —Å—Ç–æ–ø-–æ—Ä–¥–µ—Ä—ñ–≤ (–∑–∞–∑–≤–∏—á–∞–π 10 –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª—É).

**–ü—Ä–∏—á–∏–Ω–∏:**
1. –°—Ç–∞—Ä—ñ –æ—Ä–¥–µ—Ä–∏ –Ω–µ –±—É–ª–∏ –≤–∏–¥–∞–ª–µ–Ω—ñ –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –Ω–æ–≤–∏—Ö
2. Library bug –∑ `get_open_orders()` –Ω–µ –¥–æ–∑–≤–æ–ª—è—î –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –æ—Ä–¥–µ—Ä—ñ–≤ –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è
3. –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–∫–∏ -4045
4. –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –º–µ—Ö–∞–Ω—ñ–∑–º—É –æ—á–∏—â–µ–Ω–Ω—è –æ—Ä–¥–µ—Ä—ñ–≤ –ø—Ä–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—ñ –ª—ñ–º—ñ—Ç—É

**–ü—Ä–∏–∫–ª–∞–¥–∏ –∑ –ª–æ–≥—É:**
```
ERROR:exchange.binance_client:API ClientError: -4045 - Reach max stop order limit.
ERROR:core.order_manager:TP order failed: (400, -4045, 'Reach max stop order limit.', ...)
WARNING:core.position_tracker:[MITOUSDT] ‚ùå TP UPDATE FAILED: (400, -4045, 'Reach max stop order limit.', ...)
```

### –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

#### 1. –î–æ–¥–∞–Ω–æ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–∫–∏ -4045 –≤ `core/order_manager.py`

**–î–ª—è SL orders (`place_stop_loss`):**
```python
# -4045: Reach max stop order limit - need to clean up old orders
if "-4045" in error_str or "Reach max stop order limit" in error_str:
    logger.warning(f"SL order failed: Max stop order limit reached for {symbol}. Attempting to clean up old orders...")
    # Try to cancel all stop orders for this symbol to free up space
    cleanup_count = self._cleanup_all_stop_orders(symbol)
    logger.warning(f"Cleaned up {cleanup_count} stop orders for {symbol} due to max limit. Retry may be needed.")
    return OrderResult(
        success=False,
        error_code="MAX_STOP_ORDERS_REACHED",
        error_message=f"Max stop order limit reached. Cleaned up {cleanup_count} old orders. Retry may be needed."
    )
```

**–î–ª—è TP orders (`place_take_profit`):**
–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –¥–ª—è TP orders.

**–©–æ —Ü–µ –≤–∏—Ä—ñ—à—É—î:**
- –ë–æ—Ç —Ä–æ–∑–ø—ñ–∑–Ω–∞—î –ø–æ–º–∏–ª–∫—É -4045 —è–∫ –∫—Ä–∏—Ç–∏—á–Ω—É
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—á–∏—â–∞—î —Å—Ç–∞—Ä—ñ —Å—Ç–æ–ø-–æ—Ä–¥–µ—Ä–∏ –ø–µ—Ä–µ–¥ —Å–ø—Ä–æ–±–æ—é —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π
- –ü–æ–≤–µ—Ä—Ç–∞—î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π error_code –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ—ó –æ–±—Ä–æ–±–∫–∏

#### 2. –î–æ–¥–∞–Ω–æ –º–µ—Ç–æ–¥ `_cleanup_all_stop_orders()` –≤ `core/order_manager.py`

**–ú–µ—Ç–æ–¥ –æ—á–∏—â–∞—î –≤—Å—ñ —Å—Ç–æ–ø-–æ—Ä–¥–µ—Ä–∏ –¥–ª—è —Å–∏–º–≤–æ–ª—É:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —è–∫ exchange API, —Ç–∞–∫ —ñ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ç—Ä–µ–∫–µ—Ä
- –ü—Ä–∞—Ü—é—î –Ω–∞–≤—ñ—Ç—å –∫–æ–ª–∏ `get_open_orders()` –Ω–µ –ø—Ä–∞—Ü—é—î (library bug)
- –°–∫–∞—Å–æ–≤—É—î –≤—Å—ñ STOP_MARKET —Ç–∞ TAKE_PROFIT_MARKET –æ—Ä–¥–µ—Ä–∏
- –ü–æ–≤–µ—Ä—Ç–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–∫–∞—Å–æ–≤–∞–Ω–∏—Ö –æ—Ä–¥–µ—Ä—ñ–≤

**–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –æ–±–∏–¥–≤–∞ –¥–∂–µ—Ä–µ–ª–∞ (exchange API + internal tracker) –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
- –ü—Ä–æ–ø—É—Å–∫–∞—î –≤–∂–µ —Å–∫–∞—Å–æ–≤–∞–Ω—ñ –æ—Ä–¥–µ—Ä–∏
- –ü–æ–∑–Ω–∞—á–∞—î –æ—Ä–¥–µ—Ä–∏ —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è –Ω–µ –≤–¥–∞–ª–æ—Å—è

#### 3. –î–æ–¥–∞–Ω–æ cooldown –¥–ª—è –ø–æ–∑–∏—Ü—ñ–π –∑ –ø–æ–º–∏–ª–∫–æ—é -4045 –≤ `core/position_tracker.py`

**–î–ª—è SL updates:**
```python
# Check if error is due to max stop order limit
elif error_code == "MAX_STOP_ORDERS_REACHED":
    # Use shorter cooldown (2 minutes) for max stop order limit - cleanup was attempted
    self._sl_update_cooldown[position_id] = time.time() + 120.0  # 2 minutes
    logger.warning(f"[{position.symbol}] ‚ùå SL UPDATE FAILED: Max stop order limit reached. "
                  f"Cleanup attempted. Cooldown set for 2 minutes. | ...")
```

**–î–ª—è TP updates:**
–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –¥–ª—è TP updates.

**–©–æ —Ü–µ –≤–∏—Ä—ñ—à—É—î:**
- –ó–∞–ø–æ–±—ñ–≥–∞—î –ø–æ—Å—Ç—ñ–π–Ω–∏–º —Å–ø—Ä–æ–±–∞–º –æ–Ω–æ–≤–∏—Ç–∏ –æ—Ä–¥–µ—Ä–∏ –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–∫–∏ -4045
- –î–∞—î —á–∞—Å –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è –æ—Ä–¥–µ—Ä—ñ–≤ –Ω–∞ –±—ñ—Ä–∂—ñ
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∫–æ—Ä–æ—Ç—à–∏–π cooldown (2 —Ö–≤–∏–ª–∏–Ω–∏) –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ margin/leverage –ø–æ–º–∏–ª–∫–∞–º–∏ (5 —Ö–≤–∏–ª–∏–Ω)

#### 4. –ü–æ–∫—Ä–∞—â–µ–Ω–æ –æ–±—Ä–æ–±–∫—É library bug –∑ `get_open_orders()`

**–ü–æ–∫—Ä–∞—â–µ–Ω–æ –ª–æ–≥—ñ–∫—É –≤ `update_stop_loss()` —Ç–∞ `update_take_profit()`:**
- –î–æ–¥–∞–Ω–æ –∫—Ä–∞—â–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –≤–∏—è–≤–ª–µ–Ω–Ω—ñ library bug
- –ü–æ–∫—Ä–∞—â–µ–Ω–æ –æ–±—Ä–æ–±–∫—É –≤–∏–ø–∞–¥–∫—ñ–≤, –∫–æ–ª–∏ `get_open_orders()` –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ—Ä–æ–∂–Ω—ñ–π —Å–ø–∏—Å–æ–∫
- –î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —É—Å–ø—ñ—à–Ω–æ—Å—Ç—ñ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è –æ—Ä–¥–µ—Ä—ñ–≤

**–©–æ —Ü–µ –≤–∏—Ä—ñ—à—É—î:**
- –ö—Ä–∞—â–µ –æ–±—Ä–æ–±–∫–∞ –≤–∏–ø–∞–¥–∫—ñ–≤, –∫–æ–ª–∏ API –Ω–µ –ø–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫ –æ—Ä–¥–µ—Ä—ñ–≤
- –ë—ñ–ª—å—à –Ω–∞–¥—ñ–π–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è –æ—Ä–¥–µ—Ä—ñ–≤ –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –Ω–æ–≤–∏—Ö
- –ú–µ–Ω—à–µ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –æ—Ä–¥–µ—Ä—ñ–≤ —á–µ—Ä–µ–∑ library bug

### –†–µ–∑—É–ª—å—Ç–∞—Ç–∏

‚úÖ **–û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–∫–∏ -4045:** –ë–æ—Ç —Ç–µ–ø–µ—Ä —Ä–æ–∑–ø—ñ–∑–Ω–∞—î —Ç–∞ –æ–±—Ä–æ–±–ª—è—î –ø–æ–º–∏–ª–∫—É max stop order limit
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è:** –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—á–∏—â–∞—î —Å—Ç–∞—Ä—ñ –æ—Ä–¥–µ—Ä–∏ –ø—Ä–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—ñ –ª—ñ–º—ñ—Ç—É
‚úÖ **Cooldown –º–µ—Ö–∞–Ω—ñ–∑–º:** –ó–∞–ø–æ–±—ñ–≥–∞—î –ø–æ—Å—Ç—ñ–π–Ω–∏–º —Å–ø—Ä–æ–±–∞–º –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–∫–∏
‚úÖ **–ü–æ–∫—Ä–∞—â–µ–Ω–∞ –æ–±—Ä–æ–±–∫–∞ library bug:** –ö—Ä–∞—â–µ –æ–±—Ä–æ–±–∫–∞ –≤–∏–ø–∞–¥–∫—ñ–≤, –∫–æ–ª–∏ API –Ω–µ –ø—Ä–∞—Ü—é—î

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

1. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥:** –°–ª—ñ–¥–∫—É–π—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ–º–∏–ª–æ–∫ -4045
2. **–û—á–∏—â–µ–Ω–Ω—è –æ—Ä–¥–µ—Ä—ñ–≤:** –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –ø–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è, –º–æ–∂–Ω–∞ –≤—Ä—É—á–Ω—É –æ—á–∏—Å—Ç–∏—Ç–∏ –æ—Ä–¥–µ—Ä–∏ –Ω–∞ –±—ñ—Ä–∂—ñ
3. **–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:** –ú–æ–∂–Ω–∞ –∑–º–µ–Ω—à–∏—Ç–∏ —á–∞—Å—Ç–æ—Ç—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—è TP/SL, —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞ —á–∞—Å—Ç–æ –≤–∏–Ω–∏–∫–∞—î
4. **Library update:** –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É `binance-futures-connector`, –∫–æ–ª–∏ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è library bug –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–µ

### –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å –±–æ—Ç –ø–æ–≤–∏–Ω–µ–Ω:
1. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—á–∏—â–∞—Ç–∏ —Å—Ç–∞—Ä—ñ –æ—Ä–¥–µ—Ä–∏ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ -4045
2. ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ cooldown –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è —Å–ø–∞–º—É API
3. ‚úÖ –ö—Ä–∞—â–µ –æ–±—Ä–æ–±–ª—è—Ç–∏ –≤–∏–ø–∞–¥–∫–∏, –∫–æ–ª–∏ `get_open_orders()` –Ω–µ –ø—Ä–∞—Ü—é—î
4. ‚úÖ –õ–æ–≥—É–≤–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –æ—á–∏—â–µ–Ω–Ω—è –æ—Ä–¥–µ—Ä—ñ–≤

### –ü—Ä–∏–º—ñ—Ç–∫–∏

- Cooldown –¥–ª—è -4045 –ø–æ–º–∏–ª–∫–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—å 2 —Ö–≤–∏–ª–∏–Ω–∏ (–∫–æ—Ä–æ—Ç—à–∏–π, –Ω—ñ–∂ –¥–ª—è margin/leverage –ø–æ–º–∏–ª–æ–∫)
- –û—á–∏—â–µ–Ω–Ω—è –æ—Ä–¥–µ—Ä—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –æ–±–∏–¥–≤–∞ –¥–∂–µ—Ä–µ–ª–∞ (exchange API + internal tracker) –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
- –ú–µ—Ç–æ–¥ `_cleanup_all_stop_orders()` –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–ª–∏–∫–∞–Ω–∏–π –≤—Ä—É—á–Ω—É –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è –æ—Ä–¥–µ—Ä—ñ–≤
