# Підсумок останніх виправлень

## Виправлення від 13.01.2025

### 1. ✅ Додано перевірку та відновлення відсутніх SL/TP ордерів

**Проблема:** У користувача дві SHORT позиції (SWELLUSDT, THEUSDT), обидві прибуткові, але на біржі немає SL/TP ордерів.

**Рішення:** Додано функцію `_ensure_sl_tp_orders()` в `core/position_tracker.py`:
- Перевіряє наявність SL/TP ордерів на біржі при кожному оновленні позиції
- Якщо ордер відсутній, автоматично встановлює його
- Детальне логування операцій відновлення

**Файли:** `core/position_tracker.py`

### 2. ✅ Виправлено PERCENT_PRICE error при закритті hedge

**Проблема:** Hedge не може закритися через помилку PERCENT_PRICE (-4131).

**Рішення:** Додано обробку PERCENT_PRICE error в `core/hedge_manager.py`:
- Якщо MARKET order не вдається через PERCENT_PRICE, використовується STOP_MARKET з `closePosition=True`
- Trigger price встановлюється дуже близько до mark price (0.01% відстань)

**Файли:** `core/hedge_manager.py`

### 3. ⚠️ Hedge відображення

**Проблема:** Користувач каже, що hedge обробляється некоректно.

**Статус:** Логіка відображення hedge виглядає правильною - `[HEDGE]` показується тільки коли hedge існує і відкритий. Якщо `has_hedge=True`, але hedge не існує, флаг автоматично очищається.

**Потрібно перевірити:** Чому `has_hedge` флаг встановлюється неправильно (можливо, через reconciliation проблеми).

## Як працює перевірка SL/TP

1. При кожному оновленні позиції (`update_position`) викликається `_ensure_sl_tp_orders()`
2. Функція перевіряє наявність SL/TP ордерів на біржі через `get_open_orders()`
3. Якщо ордер відсутній, але ціна SL/TP встановлена в позиції, ордер автоматично встановлюється
4. Всі операції логуються для аналізу

## Наступні кроки

1. Перевірити роботу бота з новими виправленнями
2. Перевірити, чи правильно встановлюються SL/TP для існуючих позицій
3. Перевірити, чи hedge правильно відображається
